var R=h=>{throw TypeError(h)};var j=(h,e,t)=>e.has(h)||R("Cannot "+t);var F=(h,e,t)=>e.has(h)?R("Cannot add the same private member more than once"):e instanceof WeakSet?e.add(h):e.set(h,t);var A=(h,e,t)=>(j(h,e,"access private method"),t);(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const i of document.querySelectorAll('link[rel="modulepreload"]'))n(i);new MutationObserver(i=>{for(const s of i)if(s.type==="childList")for(const o of s.addedNodes)o.tagName==="LINK"&&o.rel==="modulepreload"&&n(o)}).observe(document,{childList:!0,subtree:!0});function t(i){const s={};return i.integrity&&(s.integrity=i.integrity),i.referrerPolicy&&(s.referrerPolicy=i.referrerPolicy),i.crossOrigin==="use-credentials"?s.credentials="include":i.crossOrigin==="anonymous"?s.credentials="omit":s.credentials="same-origin",s}function n(i){if(i.ep)return;i.ep=!0;const s=t(i);fetch(i.href,s)}})();const J="https://files.rcsb.org/ligands/view",K="https://models.rcsb.org/v1",Q="https://raw.githubusercontent.com/cch1999/cch1999.github.io/refs/heads/new_website/assets/files/fragment_library_ccd.tsv",Z="https://www.ebi.ac.uk/pdbe/graph-api/compound/similarity",X="https://www.ebi.ac.uk/pdbe/graph-api/compound/in_pdb",ee="https://data.rcsb.org/rest/v1/core/entry",te="https://www.ebi.ac.uk/pdbe/graph-api/pdb/summary",ne="https://files.rcsb.org/download",ie="https://www.ebi.ac.uk/pdbe/api/pdb/entry/ligand_monomers",se="https://data.rcsb.org/rest/v1/core/entry_groups",oe="https://rest.uniprot.org/uniprotkb",H="https://pubchem.ncbi.nlm.nih.gov/rest/pug/compound",re="https://pubchem.ncbi.nlm.nih.gov/compound",N="https://www.ebi.ac.uk/pdbe/static/files/pdbechem_v2",M="https://www.rcsb.org/structure",S="https://www.ebi.ac.uk/pdbe/entry/pdb",le="https://cdn.rcsb.org/images/structures",ae=["HOH","ZN","MG","CA","NA","K","CL"],de=100,ce=["HEM","NAD","FAD","COA","ATP","ADP","355","MPV","YQD","J9N","VIA"],ue=[{code:"UHV",source:"reagents",type:"reagent",pdbId:"5RH5",chainId:"A",authorResidueNumber:1001}],he=["SO4","PO4","CIT","EDO","GOL","1PE","ACE","ACT","BME","DMS","FMT","IMD","MES","PEG","PGE","TRS"],me=["ZN","MG","CA","NA","K","CL"],B=new Map;var _,k;class y{static async fetchText(e){return A(this,_,k).call(this,e,t=>t.text())}static async fetchJson(e){return A(this,_,k).call(this,e,t=>t.json())}static getCcdSdf(e){return this.fetchText(`${J}/${e.toUpperCase()}_ideal.sdf`)}static async getInstanceSdf(e,t,n){const i=await this.getLigandMonomers(e),o=((i==null?void 0:i[e.toLowerCase()])||[]).find(d=>d.chain_id===t&&d.author_residue_number===Number(n));if(!o)throw new Error(`Ligand instance not found for chain ${t} residue ${n}`);const r=o.struct_asym_id,a=o.author_residue_number;return this.fetchText(`${K}/${e.toUpperCase()}/ligand?auth_seq_id=${a}&label_asym_id=${r}&encoding=sdf`)}static getFragmentLibraryTsv(){return this.fetchText(Q)}static getSimilarCcds(e){return this.fetchJson(`${Z}/${e}`)}static getPdbEntriesForCcd(e){return this.fetchJson(`${X}/${e}`)}static getRcsbEntry(e){return this.fetchJson(`${ee}/${e.toLowerCase()}`)}static getPdbSummary(e){return this.fetchJson(`${te}/${e}`)}static getPdbFile(e){return this.fetchText(`${ne}/${e}.pdb`)}static getLigandMonomers(e){return this.fetchJson(`${ie}/${e}`)}static async getPubChemSynonyms(e){var i,s,o;const t=`${H}/name/${encodeURIComponent(e)}/synonyms/JSON`,n=await this.fetchJson(t);return((o=(s=(i=n==null?void 0:n.InformationList)==null?void 0:i.Information)==null?void 0:s[0])==null?void 0:o.Synonym)??[]}static async getPubChemProperties(e){var i,s;const t=`${H}/name/${encodeURIComponent(e)}/property/MolecularFormula,MolecularWeight,IUPACName,CanonicalSMILES/JSON`,n=await this.fetchJson(t);return((s=(i=n==null?void 0:n.PropertyTable)==null?void 0:i.Properties)==null?void 0:s[0])??null}static async getPubChemMetadata(e){const[t,n]=await Promise.all([this.getPubChemSynonyms(e).catch(()=>[]),this.getPubChemProperties(e).catch(()=>null)]),i=n==null?void 0:n.CID;return{synonyms:t,properties:n,link:i?`${re}/${i}`:null}}static async getPdbEntriesForUniprot(e){const t=e.toUpperCase(),n=`${oe}/${t}.json`,i=await this.fetchJson(n);return((i==null?void 0:i.uniProtKBCrossReferences)??[]).filter(o=>o.database==="PDB").map(o=>o.id)}static getProteinGroup(e){return this.fetchJson(`${se}/${e}`)}static clearCache(){B.clear()}}_=new WeakSet,k=async function(e,t){if(B.has(e))return B.get(e);const n=await fetch(e);if(!n.ok){const s=new Error(`HTTP error! status: ${n.status}`);throw s.status=n.status,s.url=e,s}const i=await t(n);return B.set(e,i),i},F(y,_);class pe{constructor(e,t){this.repository=e,this.cardUI=t}async loadAllMolecules(){for(const e of this.repository.getAllMolecules())e.status==="pending"&&await this.loadMolecule(e)}async loadMolecule(e){const{code:t,pdbId:n,chainId:i,authorResidueNumber:s}=typeof e=="string"?{code:e}:e;try{this.repository.updateMoleculeStatus(t,"loading");const o=n&&i&&s;let r=null;if(o||(r=await this.findMoleculeInLocalTsv(t)),r){this.repository.updateMoleculeStatus(t,"loaded"),this.cardUI.createMoleculeCardFromSmiles(r,t);return}let a;if(o?a=await y.getInstanceSdf(n,i,s):a=await y.getCcdSdf(t),!a||a.trim()===""||a.toLowerCase().includes("<html"))throw new Error("Received empty or invalid SDF data.");this.repository.updateMoleculeStatus(t,"loaded");const d=this.repository.getMolecule(t);d&&(d.sdf=a),this.cardUI.createMoleculeCard(a,t,"sdf")}catch(o){console.error(`Could not fetch or process data for ${t}:`,o),this.repository.updateMoleculeStatus(t,"error"),this.cardUI.createNotFoundCard(t,`Failed to load: ${o.message}`)}}async findMoleculeInLocalTsv(e){try{const n=(await y.getFragmentLibraryTsv()).split(`
`);for(const i of n){const s=i.split("	");if(s.length>8&&s[8]===e)return s[3]}return null}catch(t){return console.error("Error searching fragment library TSV:",t),null}}}class ge{constructor(e=[]){this.molecules=e.map(t=>({...t,id:this.generateId(t)}))}generateId(e){if(typeof e=="string")return e;const{code:t,pdbId:n,chainId:i,authorResidueNumber:s}=e;return n&&i&&s?`${n}_${i}_${s}_${t}`:t}addMolecule(e){const t=this.generateId(e);if(this.molecules.find(i=>i.id===t))return!1;const n={code:typeof e=="string"?e:e.code,status:"pending",id:t};return e&&typeof e=="object"&&Object.assign(n,e),this.molecules.push(n),!0}removeMolecule(e){const t=this.molecules.findIndex(n=>n.id===e||n.code===e);return t===-1?!1:(this.molecules.splice(t,1),!0)}deleteAllMolecules(){this.molecules=[]}getMolecule(e){return this.molecules.find(t=>t.id===e||t.code===e)}updateMoleculeStatus(e,t){const n=this.getMolecule(e);n&&(n.status=t)}getAllMolecules(){return[...this.molecules]}removeHydrogensFromSdf(e){const t=e.split(/\r?\n/);if(t.length<4)return e;const n=t[3],i=parseInt(n.slice(0,3)),s=parseInt(n.slice(3,6)),o=t.slice(4,4+i),r=t.slice(4+i,4+i+s),a=t.slice(4+i+s),d=[],l=[];o.forEach((g,f)=>{g.slice(31,34).trim()!=="H"&&(d.push(f+1),l.push(g))});const c=new Map;d.forEach((g,f)=>{c.set(g,f+1)});const u=[];r.forEach(g=>{const f=parseInt(g.slice(0,3)),m=parseInt(g.slice(3,6));if(c.has(f)&&c.has(m)){const b=String(c.get(f)).padStart(3,"0"),w=String(c.get(m)).padStart(3,"0");u.push(b+w+g.slice(6))}});const p=String(l.length).padStart(3,"0")+String(u.length).padStart(3,"0")+n.slice(6);return[...t.slice(0,3),p,...l,...u,...a].join(`
`)}exportToSdf(e={}){const{removeHydrogens:t=!1}=e;return this.molecules.filter(n=>n.sdf).map(n=>{let i=t?this.removeHydrogensFromSdf(n.sdf):n.sdf;return i=i.trimEnd(),i.endsWith("$$$$")||(i+=`
$$$$`),i}).join(`
`)}}class fe{constructor(e,t,n){this.addMolecule=e,this.showMoleculeDetails=t,this.ligandModal=n}populateBoundLigands(e){const t=document.getElementById("bound-ligands-section"),n=document.getElementById("bound-ligands-table"),i=document.getElementById("bound-ligands-tbody"),s=document.getElementById("no-bound-ligands-message"),o=document.getElementById("add-all-bound-btn");i.innerHTML="",y.getLigandMonomers(e).then(r=>{const a=r[e.toLowerCase()];if(a&&a.length>0){const d=a.filter(u=>!ae.includes(u.chem_comp_id)),l=d.length>0?d:a;t.style.display="block",n.style.display="table",s.style.display="none",l.forEach(u=>{const p=this.createBoundLigandRow(u,e);i.appendChild(p)});const c=l;c.length>0?(o.style.display="inline-block",o.textContent=`Add All (${c.length})`,o.onclick=()=>this.addAllLigands(c,"bound",e)):o.style.display="none"}else t.style.display="block",n.style.display="none",s.style.display="block",o.style.display="none"}).catch(r=>{console.error("Error fetching bound ligands:",r),t.style.display="block",n.style.display="none",s.style.display="block",s.textContent="Could not load bound ligand data.",o.style.display="none";const a=r.status&&r.url?`Failed to load bound ligands (status ${r.status}) from ${r.url}`:"Failed to load bound ligand data.";typeof showNotification=="function"&&showNotification(a,"error")})}createBoundLigandRow(e,t){const n=document.createElement("tr"),i=document.createElement("td");i.className="structure-2d";const s=document.createElement("div");s.className="loading",s.textContent="Loading...",i.appendChild(s),this.ligandModal&&this.ligandModal.load2DStructure(e.chem_comp_id,s);const o=document.createElement("td"),r=document.createElement("span");r.className="ccd-code",r.textContent=e.chem_comp_id,r.title=`Click to add ${e.chem_comp_id} to database`,r.addEventListener("click",()=>{document.getElementById("close-pdb-details-modal").click(),this.showMoleculeDetails&&this.showMoleculeDetails(e.chem_comp_id)}),o.appendChild(r);const a=document.createElement("td");a.textContent=e.chain_id;const d=document.createElement("td");d.textContent=e.author_residue_number;const l=document.createElement("td");l.textContent=e.entity_id;const c=document.createElement("td");c.className="ligand-name",c.textContent=e.chem_comp_name,c.title=e.chem_comp_name;const u=document.createElement("td"),p=document.createElement("button");return p.className="add-ligand-btn",p.innerHTML="&#43;",p.title=`Add ${e.chem_comp_id} to database`,p.addEventListener("click",()=>{this.addMolecule({code:e.chem_comp_id,pdbId:t,chainId:e.chain_id,authorResidueNumber:e.author_residue_number})?showNotification(`Adding molecule ${e.chem_comp_id}...`,"success"):showNotification(`Molecule ${e.chem_comp_id} already exists`,"info")}),u.appendChild(p),n.appendChild(i),n.appendChild(o),n.appendChild(a),n.appendChild(d),n.appendChild(l),n.appendChild(c),n.appendChild(u),n}addAllLigands(e,t,n){if(!e||e.length===0){showNotification(`No ${t} ligands to add`,"info");return}const i=document.getElementById(`add-all-${t}-btn`);i.disabled=!0,i.textContent="Adding...";let s=0,o=0;e.forEach((r,a)=>{setTimeout(()=>{if(this.addMolecule({code:r.chem_comp_id,pdbId:n,chainId:r.chain_id,authorResidueNumber:r.author_residue_number})?s++:o++,a===e.length-1){let l="";s>0&&o>0?l=`Added ${s} new molecules, ${o} already existed`:s>0?l=`Added ${s} new molecules`:l=`All ${o} molecules already existed`,showNotification(l,s>0?"success":"info"),i.disabled=!1,i.textContent=`Add All (${e.length})`}},a*de)})}}class ye{constructor(e,{notify:t=typeof window<"u"&&window.showNotification||(typeof showNotification=="function"?showNotification:()=>{}),rdkit:n=Promise.resolve(null)}={}){this.moleculeManager=e,this.fragments=[],this.grid=null,this.searchInput=null,this.sourceFilter=null,this.ccdToggle=null,this.importButton=null,this.fileInput=null,this.notify=t,this.rdkitPromise=n}init(){return this.grid=document.getElementById("fragment-grid"),this.searchInput=document.getElementById("fragment-search"),this.sourceFilter=document.getElementById("fragment-filter-source"),this.ccdToggle=document.getElementById("ccd-toggle"),this.importButton=document.getElementById("import-fragment-btn"),this.fileInput=document.getElementById("fragment-sdf-input"),this.addEventListeners(),this}addEventListeners(){this.searchInput&&this.searchInput.addEventListener("input",()=>this.renderFragments()),this.sourceFilter&&this.sourceFilter.addEventListener("change",()=>this.renderFragments()),this.ccdToggle&&this.ccdToggle.addEventListener("change",()=>this.renderFragments()),this.importButton&&this.fileInput&&(this.importButton.addEventListener("click",()=>this.fileInput.click()),this.fileInput.addEventListener("change",e=>{const t=e.target.files&&e.target.files[0];this.handleSdfUpload(t)}))}async loadFragments(){try{const t=(await y.getFragmentLibraryTsv()).split(`
`).slice(1);this.fragments=t.map((n,i)=>{const s=n.split("	");return s.length<10?null:{id:s[0]||i,name:s[1],kind:s[2],query:s[3],description:s[4],comment:s[5],url:s[6],source:s[7],ccd:s[8],in_ccd:s[9].trim()==="True"}}).filter(Boolean),this.renderFragments()}catch(e){console.error("Failed to load fragment library:",e),this.grid&&(this.grid.innerHTML="<p>No fragments match your criteria.</p>")}}renderFragments(){if(!this.grid)return;this.grid.innerHTML="";const e=this.searchInput?this.searchInput.value.toLowerCase().trim():"",t=this.sourceFilter?this.sourceFilter.value:"all",n=this.ccdToggle?this.ccdToggle.checked:!1,i=this.fragments.filter(o=>{const r=o.name.toLowerCase().includes(e)||o.source.toLowerCase().includes(e),a=t==="all"||o.source===t,d=!n||o.in_ccd;return r&&a&&d});if(i.length===0){this.grid.innerHTML="<p>No fragments match your criteria.</p>";return}const s=document.createDocumentFragment();i.forEach(o=>{const r=this.createFragmentCard(o);s.appendChild(r)}),this.grid.appendChild(s)}createFragmentCard(e){const t=document.createElement("div");t.className="molecule-card fragment-card";const n=document.createElement("h3");n.textContent=e.name,t.appendChild(n);const i=document.createElement("div");i.className="viewer-container",t.appendChild(i);const s=document.createElement("div");s.className="fragment-info";let o="No";if(e.in_ccd&&e.ccd){const a=e.ccd.split(",")[0].trim();o=`Yes (<a href="#" class="ccd-link" data-ccd="${a}">${a}</a>)`}s.innerHTML=`
            <p><strong>Source:</strong> ${e.source}</p>
            <p><strong>In CCD:</strong> ${o}</p>
            <p><strong>Type:</strong> ${e.kind}</p>
        `,t.appendChild(s);const r=s.querySelector(".ccd-link");if(r&&r.addEventListener("click",a=>{a.preventDefault();const d=a.target.dataset.ccd;this.moleculeManager&&this.moleculeManager.showMoleculeDetails&&this.moleculeManager.showMoleculeDetails(d)}),e.in_ccd&&e.ccd){const a=e.ccd.split(",")[0].trim(),d=this.moleculeManager.getMolecule(a),l=document.createElement("button");l.textContent=d?"In library":"Add to library",l.className="add-to-library-btn",d&&(l.disabled=!0,l.classList.add("added")),l.addEventListener("click",c=>{c.stopPropagation(),this.moleculeManager.addMolecule(a)?(this.notify(`Adding molecule ${a} to library...`,"success"),l.textContent="Added to library",l.disabled=!0,l.classList.add("added")):(this.notify(`Molecule ${a} already exists.`,"info"),l.textContent="In library",l.disabled=!0,l.classList.add("added"))}),t.appendChild(l)}return setTimeout(()=>{(e.kind==="SMILES"||e.kind==="SMARTS")&&e.query?this.rdkitPromise.then(a=>{if(!a){i.innerHTML='<p class="render-error">RDKit not available</p>';return}try{const d=this.sanitizeSMILES(e.query),l=a.get_mol(d),c=l.get_svg(200,150);l.delete(),i.innerHTML=c}catch(d){console.error("Error rendering SMILES for "+e.name,d),i.innerHTML=`<p class="render-error">Render error for query: ${e.query}</p>`}}):e.kind==="SDF"&&e.query?this.rdkitPromise.then(a=>{if(!a){i.innerHTML='<p class="render-error">RDKit not available</p>';return}try{const d=a.get_mol(e.query),l=d.get_svg(200,150);d.delete(),i.innerHTML=l}catch(d){console.error("Error rendering SDF for "+e.name,d),i.innerHTML='<p class="render-error">Render error for SDF</p>'}}):i.innerHTML=`<p class="render-error">Cannot render type: ${e.kind||"N/A"}</p>`},50),t}addFragment(e){return!e.name||!e.query?(this.notify("Fragment name and SMILES/SMARTS query are required.","error"),!1):this.fragments.some(n=>n.name.toLowerCase()===e.name.toLowerCase())?(this.notify(`Fragment "${e.name}" already exists.`,"error"),!1):(this.fragments.unshift({id:`custom-${Date.now()}`,name:e.name,kind:"SMILES",query:e.query,description:e.description,comment:"Custom fragment",url:"",source:e.source||"custom",ccd:"",in_ccd:!1}),this.ensureSourceOption(e.source||"custom"),this.renderFragments(),this.notify(`Fragment "${e.name}" added successfully!`,"success"),!0)}handleSdfUpload(e){if(!e)return;const t=e.name.replace(/\.sdf$/i,"");let n=t;if(typeof window<"u"&&typeof window.prompt=="function"){const i=window.prompt("Enter fragment library name",t);i&&i.trim()&&(n=i.trim())}e.text().then(i=>this.importFragmentsFromSdf(i,n)).then(i=>{i>0?this.notify(`${i} fragments imported from ${e.name}`,"success"):this.notify("No fragments were imported from SDF","error"),this.fileInput.value=""}).catch(i=>{console.error("Failed to import SDF file:",i),this.notify("Failed to import SDF file","error"),this.fileInput.value=""})}async importFragmentsFromSdf(e,t="custom"){if(!e)return 0;const n=await this.rdkitPromise,i=e.split(/\$\$\$\$/).map(o=>o.trim()).filter(Boolean);let s=0;for(let o=0;o<i.length;o++){const r=i[o];let a="";if(n)try{const l=n.get_mol(r);a=l.get_smiles(),l.delete()}catch(l){console.error("Failed to compute SMILES for fragment",l)}if(!a){const l=r.split(/\r?\n/);a=l[0]?l[0].trim():`Fragment ${o+1}`}this.fragments.some(l=>l.name.toLowerCase()===a.toLowerCase())||(this.fragments.unshift({id:`custom-${Date.now()}-${o}`,name:a,kind:"SDF",query:r,description:"",comment:"Custom fragment",url:"",source:t,ccd:"",in_ccd:!1}),s++)}return s>0&&(this.ensureSourceOption(t),this.renderFragments()),s}ensureSourceOption(e){if(!this.sourceFilter)return;if(!Array.from(this.sourceFilter.children).some(n=>n.value===e)){const n=document.createElement("option");n.value=e,n.textContent=e,this.sourceFilter.appendChild(n)}}sanitizeSMILES(e){return e?e.replace(/[^A-Za-z0-9\(\)\[\]\.\-=#$:@\/\\]/g,""):""}}class be{constructor(e){this.moleculeManager=e,this.modal=document.getElementById("molecule-details-modal"),this.detailsTitle=document.getElementById("details-title"),this.detailsCode=document.getElementById("details-code"),this.detailsSource=document.getElementById("details-source"),this.detailsType=document.getElementById("details-type"),this.detailsStructure=document.getElementById("details-structure"),this.pdbInstanceFields=document.querySelectorAll(".pdb-instance-field"),this.detailsPdbId=document.getElementById("details-pdb-id"),this.detailsChain=document.getElementById("details-chain"),this.detailsResidue=document.getElementById("details-residue"),this.detailsViewer=document.getElementById("details-viewer-container"),this.detailsJSON=document.getElementById("details-json"),this.viewer=null;const t=document.getElementById("close-details-modal");t&&t.addEventListener("click",()=>this.close()),window.addEventListener("click",n=>{n.target===this.modal&&this.close()})}show(e,t){this.cleanupViewer(),this.detailsTitle.textContent=`Molecule Details: ${e}`,this.detailsCode.textContent=e;const n=["ALA","ARG","ASN","ASP","CYS","GLN","GLU","GLY","HIS","ILE","LEU","LYS","MET","PHE","PRO","SER","THR","TRP","TYR","VAL"].includes(e);this.detailsSource.textContent=n?"building_blocks":"reagents",this.detailsType.textContent=n?"building_block":"reagent";const i=this.moleculeManager.getMolecule?this.moleculeManager.getMolecule(e):null,s=i&&i.pdbId&&i.chainId&&i.authorResidueNumber;this.detailsStructure&&(this.detailsStructure.textContent=s?"PDB instance":"Ideal CCD SDF"),this.pdbInstanceFields&&this.pdbInstanceFields.forEach(r=>{r.style.display=s?"flex":"none"}),s?(this.detailsPdbId&&(this.detailsPdbId.textContent=i.pdbId.toUpperCase()),this.detailsChain&&(this.detailsChain.textContent=i.chainId),this.detailsResidue&&(this.detailsResidue.textContent=i.authorResidueNumber)):(this.detailsPdbId&&(this.detailsPdbId.textContent="-"),this.detailsChain&&(this.detailsChain.textContent="-"),this.detailsResidue&&(this.detailsResidue.textContent="-")),this.detailsViewer.innerHTML="<p>Loading structure...</p>",s?y.getPdbFile(i.pdbId).then(r=>{setTimeout(()=>{var a,d;try{const l=(d=(a=document.body)==null?void 0:a.classList)!=null&&d.contains("dark-mode")?"#e0e0e0":"white",c=$3Dmol.createViewer(this.detailsViewer,{backgroundColor:l,width:"100%",height:"100%"});this.detailsViewer.viewer=c,c.addModel(r,"pdb"),c.setStyle({},{cartoon:{color:"lightgrey"}});const u={chain:i.chainId,resi:parseInt(i.authorResidueNumber,10)},p={within:{distance:5,sel:u}};c.setStyle(p,{stick:{radius:.15,colorscheme:"element"}}),c.setStyle(u,{stick:{radius:.2,colorscheme:"element"},sphere:{scale:.3,colorscheme:"element"}}),c.addSurface($3Dmol.SurfaceType.MS,{opacity:.6,color:"white"},p),c.zoomTo(u),c.render(),this.viewer=c}catch(l){console.error(`Error initializing PDB viewer for ${e}:`,l),this.detailsViewer.innerHTML='<p style="color: #666;">Structure rendering error</p>'}},100)}).catch(r=>{console.error(`Error fetching PDB for ${e}:`,r),this.detailsViewer.innerHTML='<p style="color: #666;">Structure data not available</p>'}):t?setTimeout(()=>{var r,a;try{const d=(a=(r=document.body)==null?void 0:r.classList)!=null&&a.contains("dark-mode")?"#e0e0e0":"white",l=$3Dmol.createViewer(this.detailsViewer,{backgroundColor:d,width:"100%",height:"100%"});this.detailsViewer.viewer=l,l.addModel(t,"sdf"),l.setStyle({},{stick:{radius:.2,colorscheme:"element"},sphere:{scale:.3,colorscheme:"element"}}),l.setStyle({elem:"H"},{}),l.zoomTo(),l.render(),this.viewer=l}catch(d){console.error(`Error initializing details viewer for ${e}:`,d),this.detailsViewer.innerHTML='<p style="color: #666;">Structure rendering error</p>'}},100):this.detailsViewer.innerHTML='<p style="color: #666;">Structure data not available</p>';const o={molecule_id:`mol_${e.toLowerCase()}`,ccd_code:e,source:n?"building_blocks":"reagents",type:n?"building_block":"reagent",structure_type:s?"pdb_instance":"ideal_sdf",structure_data:t?t.substring(0,100)+"...":"N/A",properties:{molecular_weight:null,formula:null,status:i?i.status:"unknown"}};s&&(o.pdb_instance={pdb_id:i.pdbId,chain_id:i.chainId,author_residue_number:i.authorResidueNumber}),this.detailsJSON.textContent=JSON.stringify(o,null,2),this.modal.style.display="block"}close(){this.cleanupViewer(),this.modal.style.display="none"}cleanupViewer(){var e,t;if(this.viewer){try{this.viewer.clear(),typeof this.viewer.destroy=="function"?this.viewer.destroy():(e=this.viewer)!=null&&e.gl&&typeof this.viewer.gl.getExtension=="function"&&((t=this.viewer.gl.getExtension("WEBGL_lose_context"))==null||t.loseContext())}catch(n){console.warn("Error destroying viewer:",n)}this.viewer=null}this.detailsViewer&&(this.detailsViewer.innerHTML="",this.detailsViewer.viewer=null)}}class we{constructor(e){this.moleculeManager=e,this.currentSimilarLigands=[]}async load(e){var o,r,a,d,l,c,u,p,g;const t=document.getElementById("similar-ligands-container"),n=document.getElementById("similar-ligands-table"),i=document.getElementById("similar-ligands-tbody"),s=document.getElementById("add-all-similar-btn");this.currentSimilarLigands=[];try{t.innerHTML="<p>Loading similar ligands...</p>",n.style.display="none",s.style.display="none";const m=(await y.getSimilarCcds(e))[e];if(!m||!((r=(o=m[0])==null?void 0:o.stereoisomers)!=null&&r.length)&&!((d=(a=m[0])==null?void 0:a.same_scaffold)!=null&&d.length)&&!((c=(l=m[0])==null?void 0:l.similar_ligands)!=null&&c.length)){t.innerHTML='<div class="no-similar-ligands">No similar ligands found</div>';return}i.innerHTML="";const b=(w,E)=>{E.forEach(I=>{this.currentSimilarLigands.push(I);const L=this.createSimilarLigandRow(w,I);i.appendChild(L)})};(u=m[0])!=null&&u.stereoisomers&&b("stereoisomer",m[0].stereoisomers),(p=m[0])!=null&&p.same_scaffold&&b("scaffold",m[0].same_scaffold),(g=m[0])!=null&&g.similar_ligands&&b("similar",m[0].similar_ligands),t.style.display="none",n.style.display="table",this.currentSimilarLigands.length>0&&(s.style.display="inline-block",s.textContent=`Add All (${this.currentSimilarLigands.length})`,s.replaceWith(s.cloneNode(!0)),document.getElementById("add-all-similar-btn").addEventListener("click",()=>this.addAllSimilarLigands()))}catch(f){console.error(`Error fetching similar CCDs for ${e}:`,f),t.innerHTML='<div class="no-similar-ligands">Similar ligands feature temporarily unavailable due to CORS restrictions. <br><small>In production, this would be handled via a backend proxy.</small></div>',e==="ATP"&&this.showDemoSimilarLigands()}}addAllSimilarLigands(){if(!this.currentSimilarLigands||this.currentSimilarLigands.length===0){showNotification("No similar ligands to add","info");return}const e=document.getElementById("add-all-similar-btn");e.disabled=!0,e.textContent="Adding...";let t=0,n=0;this.currentSimilarLigands.forEach((i,s)=>{setTimeout(()=>{if(this.moleculeManager.addMolecule(i.chem_comp_id)?t++:n++,s===this.currentSimilarLigands.length-1){let r="";t>0&&n>0?r=`Added ${t} new molecules, ${n} already existed`:t>0?r=`Added ${t} new molecules`:r=`All ${n} molecules already existed`,showNotification(r,t>0?"success":"info"),e.disabled=!1,e.textContent=`Add All (${this.currentSimilarLigands.length})`}},s*100)})}createSimilarLigandRow(e,t){const n=document.createElement("tr"),i=document.createElement("td");i.className="structure-2d";const s=document.createElement("div");s.className="loading",s.textContent="Loading...",i.appendChild(s),this.load2DStructure(t.chem_comp_id,s);const o=document.createElement("td"),r=document.createElement("span");r.className=`type-badge type-${e}`;let a="";switch(e){case"stereoisomer":a="Stereoisomer";break;case"scaffold":a="Same Scaffold";break;case"similar":a="Similar";break}r.textContent=a,o.appendChild(r);const d=document.createElement("td"),l=document.createElement("span");l.className="ccd-code",l.textContent=t.chem_comp_id,l.title=`Click to add ${t.chem_comp_id} to database`,l.addEventListener("click",()=>{document.getElementById("close-details-modal").click(),this.moleculeManager.showMoleculeDetails(t.chem_comp_id)}),d.appendChild(l);const c=document.createElement("td");c.className="ligand-name",c.textContent=t.name||"N/A";const u=document.createElement("td");if(u.className="match-info",t.similarity_score){const f=Math.round(t.similarity_score*100);u.textContent=`${f}% similarity`}else t.substructure_match&&t.substructure_match.length>0?u.textContent=t.substructure_match.join(", "):u.textContent="-";const p=document.createElement("td"),g=document.createElement("button");return g.className="add-ligand-btn",g.innerHTML="&#43;",g.title=`Add ${t.chem_comp_id} to database`,g.addEventListener("click",()=>{this.moleculeManager.addMolecule(t.chem_comp_id)?showNotification(`Adding molecule ${t.chem_comp_id}...`,"success"):showNotification(`Molecule ${t.chem_comp_id} already exists`,"info")}),p.appendChild(g),n.appendChild(i),n.appendChild(o),n.appendChild(d),n.appendChild(c),n.appendChild(u),n.appendChild(p),n}async load2DStructure(e,t){try{const n=`${N}/${e.toUpperCase()}_200.svg`,i=document.createElement("img");i.src=n,i.alt=`2D structure of ${e}`,i.onload=()=>{t.innerHTML="",t.appendChild(i)},i.onerror=()=>{const s=`${N}/${e.toLowerCase()}_200.svg`,o=document.createElement("img");o.src=s,o.alt=`2D structure of ${e}`,o.onload=()=>{t.innerHTML="",t.appendChild(o)},o.onerror=()=>{t.className="error",t.textContent="No image"}}}catch(n){console.error(`Error loading 2D structure for ${e}:`,n),t.className="error",t.textContent="Error"}}showDemoSimilarLigands(){const e=document.getElementById("similar-ligands-container"),t=document.getElementById("similar-ligands-table"),n=document.getElementById("similar-ligands-tbody"),i=[{type:"stereoisomer",chem_comp_id:"HEJ",name:"9-{5-O-[(S)-hydroxy{[(R)-hydroxy(phosphonooxy)phosphoryl]oxy}phosphoryl]-beta-D-arabinofuranosyl}-9H-purin-6-amine",substructure_match:[]},{type:"scaffold",chem_comp_id:"E7X",name:"(2~{S})-4-[[(2~{R},3~{S},4~{R},5~{R})-5-(6-aminopurin-9-yl)-3,4-bis(oxidanyl)oxolan-2-yl]methyl-(2-hydroxyethyl)amino]-2-azaniumyl-butanoate",substructure_match:["N7"]},{type:"scaffold",chem_comp_id:"ADP",name:"Adenosine 5-diphosphate",substructure_match:["N1","N3","N7","N9"]}];n.innerHTML="",i.forEach(s=>{const o=this.createSimilarLigandRow(s.type,s);n.appendChild(o)}),e.innerHTML='<div style="background: #e8f5e8; padding: 10px; border-radius: 4px; margin-bottom: 10px; font-size: 13px;"><strong>Demo Data:</strong> Showing sample similar ligands for ATP. In production, this would fetch real data from the PDBe API.</div>',t.style.display="table"}}class ve{constructor(e){this.moleculeManager=e}async load(e){const t=document.getElementById("pdb-entries-container"),n=document.getElementById("pdb-entries-table-container"),i=document.getElementById("pdb-entries-tbody");try{t.innerHTML="<p>Loading PDB entries...</p>",i.innerHTML="",n.style.display="none",n.querySelectorAll('p[style*="font-size: 12px"]').forEach(d=>d.remove());const r=(await y.getPdbEntriesForCcd(e))[e];if(!r||r.length===0){t.innerHTML='<div class="no-pdb-entries">No PDB entries found containing this CCD code</div>';return}i.innerHTML="";const a=r.slice(0,10);console.log(`Found ${r.length} PDB entries for ${e}, showing first ${a.length}`);for(const d of a)try{const l=await this.moleculeManager.fetchRCSBDetails(d),c=this.createDetailedPDBEntryRow(d,l);i.appendChild(c)}catch(l){console.warn(`Failed to fetch details for ${d}:`,l);const c=this.createSimplePDBEntryRow(d);i.appendChild(c)}if(t.style.display="none",n.style.display="block",r.length>10){const d=document.createElement("p");d.style.fontSize="12px",d.style.color="#666",d.style.fontStyle="italic",d.style.marginTop="10px",d.textContent=`Showing first 10 of ${r.length} PDB entries containing ${e}`,n.appendChild(d)}}catch(s){console.error(`Error fetching PDB entries for ${e}:`,s),i.innerHTML="",n.style.display="none",t.innerHTML='<div class="no-pdb-entries">PDB entries feature temporarily unavailable due to CORS restrictions. <br><small>In production, this would be handled via a backend proxy.</small></div>',e==="ATP"&&this.showDemoPDBEntries()}}createDetailedPDBEntryRow(e,t){const n=document.createElement("tr"),i=document.createElement("td"),s=document.createElement("span");s.className="pdb-id",s.textContent=e.toUpperCase(),s.title=`Click to view details for ${e.toUpperCase()}`,s.addEventListener("click",()=>{this.moleculeManager.showPDBDetailsModal(e)}),i.appendChild(s);const o=document.createElement("td");o.className="pdb-title",t&&t.struct&&t.struct.title?(o.textContent=t.struct.title,o.title=t.struct.title):o.textContent="N/A";const r=document.createElement("td");r.className="pdb-resolution",t&&t.rcsb_entry_info&&t.rcsb_entry_info.resolution_combined&&t.rcsb_entry_info.resolution_combined.length>0?r.textContent=`${t.rcsb_entry_info.resolution_combined[0].toFixed(2)}`:r.textContent="N/A";const a=document.createElement("td");if(a.className="pdb-date",t&&t.rcsb_accession_info&&t.rcsb_accession_info.initial_release_date){const u=new Date(t.rcsb_accession_info.initial_release_date);a.textContent=u.toLocaleDateString()}else a.textContent="N/A";const d=document.createElement("td");d.className="view-buttons-cell";const l=document.createElement("button");l.textContent="RCSB PDB",l.className="view-structure-btn rcsb-btn",l.title=`View ${e.toUpperCase()} on RCSB PDB`,l.addEventListener("click",()=>{window.open(`${M}/${e.toUpperCase()}`,"_blank")});const c=document.createElement("button");return c.textContent="PDBe",c.className="view-structure-btn pdbe-btn",c.title=`View ${e.toUpperCase()} on PDBe`,c.addEventListener("click",()=>{window.open(`${S}/${e.toLowerCase()}`,"_blank")}),d.appendChild(l),d.appendChild(c),n.appendChild(i),n.appendChild(o),n.appendChild(r),n.appendChild(a),n.appendChild(d),n}createSimplePDBEntryRow(e){const t=document.createElement("tr"),n=document.createElement("td"),i=document.createElement("span");i.className="pdb-id",i.textContent=e.toUpperCase(),i.title=`Click to view details for ${e.toUpperCase()}`,i.addEventListener("click",()=>{this.moleculeManager.showPDBDetailsModal(e)}),n.appendChild(i);const s=document.createElement("td");s.textContent="Loading...",s.className="pdb-title";const o=document.createElement("td");o.textContent="N/A",o.className="pdb-resolution";const r=document.createElement("td");r.textContent="N/A",r.className="pdb-date";const a=document.createElement("td");a.className="view-buttons-cell";const d=document.createElement("button");d.textContent="RCSB PDB",d.className="view-structure-btn rcsb-btn",d.title=`View ${e.toUpperCase()} on RCSB PDB`,d.addEventListener("click",()=>{window.open(`${M}/${e.toUpperCase()}`,"_blank")});const l=document.createElement("button");return l.textContent="PDBe",l.className="view-structure-btn pdbe-btn",l.title=`View ${e.toUpperCase()} on PDBe`,l.addEventListener("click",()=>{window.open(`${S}/${e.toLowerCase()}`,"_blank")}),a.appendChild(d),a.appendChild(l),t.appendChild(n),t.appendChild(s),t.appendChild(o),t.appendChild(r),t.appendChild(a),t}showDemoPDBEntries(){const e=document.getElementById("pdb-entries-container"),t=document.getElementById("pdb-entries-table-container"),n=document.getElementById("pdb-entries-tbody");n.innerHTML="",t.querySelectorAll('p[style*="font-size: 12px"]').forEach(o=>o.remove()),[{pdb_id:"1atp",title:"CRYSTAL STRUCTURE OF THE TERNARY COMPLEX OF PHENYLALANYL-TRNA SYNTHETASE WITH TRNA AND A PHENYLALANYL-ADENYLATE ANALOGUE",resolution:2.7,release_date:"1995-01-31"},{pdb_id:"2atp",title:"ADENOSINE-5'-TRIPHOSPHATE",resolution:1.83,release_date:"1996-07-17"},{pdb_id:"3atp",title:"ATP SYNTHASE",resolution:2.4,release_date:"1999-02-24"},{pdb_id:"1a49",title:"CRYSTAL STRUCTURE OF ADENYLYL CYCLASE",resolution:2.8,release_date:"1998-04-15"},{pdb_id:"1a5u",title:"ATP BINDING CASSETTE TRANSPORTER",resolution:3.2,release_date:"1998-08-12"}].forEach(o=>{const r={struct:{title:o.title},rcsb_entry_info:{resolution_combined:[o.resolution]},rcsb_accession_info:{initial_release_date:o.release_date}},a=this.createDetailedPDBEntryRow(o.pdb_id,r);n.appendChild(a)}),e.innerHTML='<div style="background: #fff3cd; color: #856404; padding: 10px; border-radius: 4px; font-size: 12px; margin-bottom: 10px;">Demo data shown due to CORS restrictions. In production, this would show all PDB entries containing ATP.</div>',t.style.display="block"}}const Ee="https://data.rcsb.org/rest/v1/core/chemcomp";class Ce{static async getProperties(e){try{const t=await fetch(`${Ee}/${e.toUpperCase()}`);if(!t.ok)throw new Error(`HTTP error ${t.status}`);const n=await t.json(),i=(n==null?void 0:n.chem_comp)||{},s=(n==null?void 0:n.rcsb_chem_comp_info)||{};return{molecularWeight:i.formula_weight??null,formula:i.formula??null,atomCount:s.atom_count??null,heavyAtomCount:s.atom_count_heavy??null,aromaticBondCount:s.bond_count_aromatic??null}}catch(t){return console.error(`Failed to fetch properties for ${e}:`,t),null}}}class Ie{constructor(e){this.details=new be(e),this.similarLigandTable=new we(e),this.pdbEntryList=new ve(e),this.propertiesContainer=document.getElementById("ligand-properties")}show(e,t){this.details.show(e,t),this.similarLigandTable.load(e),this.pdbEntryList.load(e),this.propertiesContainer&&(this.propertiesContainer.textContent="Loading properties...",Promise.all([Ce.getProperties(e).catch(()=>null),y.getPubChemMetadata(e).catch(()=>null)]).then(([n,i])=>{var a,d,l;if(!n&&!i){this.propertiesContainer.textContent="Properties unavailable";return}let s="";const o=((a=i==null?void 0:i.properties)==null?void 0:a.MolecularWeight)??(n==null?void 0:n.molecularWeight),r=((d=i==null?void 0:i.properties)==null?void 0:d.MolecularFormula)??(n==null?void 0:n.formula);(o||r)&&(s+=`<div>Molecular Weight: ${o??"N/A"}</div>`,s+=`<div>Formula: ${r??"N/A"}</div>`),n&&(n.atomCount!=null&&(s+=`<div>Atom Count: ${n.atomCount}</div>`),n.heavyAtomCount!=null&&(s+=`<div>Heavy Atom Count: ${n.heavyAtomCount}</div>`),n.aromaticBondCount!=null&&(s+=`<div>Aromatic Bond Count: ${n.aromaticBondCount}</div>`)),(l=i==null?void 0:i.properties)!=null&&l.IUPACName&&(s+=`<div>IUPAC Name: ${i.properties.IUPACName}</div>`),i!=null&&i.synonyms&&i.synonyms.length&&(s+=`<div>Synonyms: ${i.synonyms.slice(0,5).join(", ")}</div>`),i!=null&&i.link&&(s+=`<div><a href="${i.link}" target="_blank">PubChem Entry</a></div>`),this.propertiesContainer.innerHTML=s}).catch(()=>{this.propertiesContainer.textContent="Properties unavailable"}))}close(){this.details.close()}load2DStructure(e,t){return this.similarLigandTable.load2DStructure(e,t)}}class Le{constructor(e,t,n={}){this.grid=e,this.repository=t,this.onDelete=n.onDelete,this.onShowDetails=n.onShowDetails,this.onCompare=n.onCompare,this.draggedElement=null}createBaseCard(e,t=e,n){const i=document.createElement("div");i.className="molecule-card",i.draggable=!0,i.setAttribute("data-molecule-code",e),i.setAttribute("data-molecule-id",t);const s=document.createElement("div");s.className="drag-handle",s.innerHTML="⋯",i.appendChild(s);const o=document.createElement("div");o.className="delete-btn",o.innerHTML='<svg viewBox="0 0 24 24" width="16" height="16"><path fill="currentColor" d="M19,4H15.5L14.5,3H9.5L8.5,4H5V6H19M6,19A2,2 0 0,0 8,21H16A2,2 0 0,0 18,19V7H6V19Z"/></svg>',o.title=`Delete ${e}`,o.addEventListener("click",d=>{d.stopPropagation(),this.onDelete&&this.onDelete(e)}),i.appendChild(o);const r=document.createElement("div");r.className="download-btn",r.innerHTML='<svg viewBox="0 0 24 24" width="16" height="16"><path fill="currentColor" d="M5 20h14v-2H5m14-9h-4V3H9v6H5l7 7 7-7Z"/></svg>',r.title=`Download ${e} as SDF`,r.addEventListener("click",d=>{d.stopPropagation(),this.downloadSdf(e,n)}),i.appendChild(r);const a=document.createElement("div");return a.className="compare-btn",a.textContent="⇆",a.title=`Compare ${e}`,a.addEventListener("click",d=>{d.stopPropagation(),this.onCompare&&this.onCompare(e)}),i.appendChild(a),i}createMoleculeCardFromSmiles(e,t,n=t){const i=this.createBaseCard(t,n),s=document.createElement("div");s.className="molecule-code",s.textContent=t,i.appendChild(s);const o=document.createElement("div");o.className="molecule-viewer",o.id=`viewer-${t}`,i.appendChild(o);const r=document.createElement("div");r.className="smiles-label",r.textContent=`SMILES: ${e}`,r.style.fontSize="10px",r.style.color="#666",r.style.marginTop="5px",i.appendChild(r),this.grid.appendChild(i),this.renderSmilesIn2D(e,o),this.addDragEvents(i)}renderSmilesIn2D(e,t){t.innerHTML=`
            <div style="display:flex;align-items:center;justify-content:center;height:100%;background:#f8f9fa;border:1px solid #e9ecef;border-radius:4px;">
                <div style="text-align:center;padding:10px;">
                    <div style="font-size:24px;margin-bottom:5px;">🧪</div>
                    <div style="font-size:10px;color:#666;">SMILES</div>
                </div>
            </div>
        `}createMoleculeCard(e,t,n="sdf",i=t){const s=this.createBaseCard(t,i,e),o=document.createElement("h3");o.textContent=t,o.style.cursor="pointer",o.addEventListener("click",()=>{this.onShowDetails&&this.onShowDetails(t,e,n)}),s.appendChild(o);const r=document.createElement("div");r.id=`viewer-${t}`,r.className="viewer-container",s.appendChild(r),this.grid.appendChild(s),this.addDragEvents(s),setTimeout(()=>{var a,d;try{const l=(d=(a=document.body)==null?void 0:a.classList)!=null&&d.contains("dark-mode")?"#e0e0e0":"white",c=$3Dmol.createViewer(r,{backgroundColor:l});r.viewer=c,c.addModel(e,n),c.setStyle({},{stick:{}}),c.setStyle({elem:"H"},{}),c.zoomTo(),c.render()}catch(l){console.error(`Error initializing 3Dmol viewer for ${t}:`,l),r.innerHTML='<p style="text-align:center;padding:20px;">Render Error</p>'}},100)}createNotFoundCard(e,t="Not found",n=e){const i=this.createBaseCard(e,n),s=document.createElement("div");s.className="not-found-content",s.innerHTML=`<h3>${e}</h3><p>${t}</p>`,i.appendChild(s),this.grid.appendChild(i),this.addDragEvents(i)}addDragEvents(e){e.addEventListener("dragstart",t=>this.handleDragStart(t)),e.addEventListener("dragover",t=>this.handleDragOver(t)),e.addEventListener("drop",t=>this.handleDrop(t)),e.addEventListener("dragend",t=>this.handleDragEnd(t))}handleDragStart(e){this.draggedElement=e.currentTarget,e.currentTarget.classList.add("dragging"),e.dataTransfer.effectAllowed="move",e.dataTransfer.setData("text/html",e.currentTarget.outerHTML)}handleDragOver(e){return e.preventDefault&&e.preventDefault(),e.dataTransfer.dropEffect="move",!1}handleDrop(e){if(e.stopPropagation&&e.stopPropagation(),this.draggedElement!==e.currentTarget){const t=Array.from(this.grid.querySelectorAll(".molecule-card")),n=t.indexOf(this.draggedElement),i=t.indexOf(e.currentTarget);n<i?e.currentTarget.parentNode.insertBefore(this.draggedElement,e.currentTarget.nextSibling):e.currentTarget.parentNode.insertBefore(this.draggedElement,e.currentTarget);const s=this.repository.molecules,o=this.draggedElement.getAttribute("data-molecule-code"),r=e.currentTarget.getAttribute("data-molecule-code"),a=s.findIndex(l=>l.code===o),d=s.findIndex(l=>l.code===r);if(a>-1&&d>-1){const[l]=s.splice(a,1);s.splice(d,0,l)}}return!1}handleDragEnd(e){e.currentTarget.classList.remove("dragging"),this.draggedElement=null}async downloadSdf(e,t){try{let n=t;if(n||(n=await y.getCcdSdf(e)),!n)throw new Error("No SDF data available");const i=new Blob([n],{type:"chemical/x-mdl-sdfile"}),s=URL.createObjectURL(i),o=document.createElement("a");o.href=s,o.download=`${e}.sdf`,document.body.appendChild(o),o.click(),document.body.removeChild(o),URL.revokeObjectURL(s)}catch(n){console.error(`Failed to download SDF for ${e}:`,n)}}clearAll(){this.grid.querySelectorAll(".molecule-card").forEach(t=>t.remove())}}class _e{constructor(e){this.boundLigandTable=e,this.modal=document.getElementById("pdb-details-modal");const t=document.getElementById("close-pdb-details-modal");t&&t.addEventListener("click",()=>this.close()),window.addEventListener("click",n=>{n.target===this.modal&&this.close()})}async fetchRCSBDetails(e){try{return await y.getRcsbEntry(e)}catch(t){return console.error(`Error fetching RCSB details for PDB ${e}:`,t),null}}async showPDBDetailsModal(e){const t=document.getElementById("pdb-details-title"),n=document.getElementById("pdb-details-body"),i=document.getElementById("pdb-viewer-container");t.textContent=`PDB Entry Details: ${e.toUpperCase()}`,n.innerHTML='<div class="properties-loading">Loading PDB entry details...</div>',i.innerHTML="",i.style.display="none",this.modal.style.display="block";try{const s=await this.fetchRCSBDetails(e);if(!s)throw new Error("No data found for this PDB entry.");n.innerHTML=this.createPDBDetailsHTML(s),this.boundLigandTable&&this.boundLigandTable.populateBoundLigands(e),document.getElementById("open-rcsb-btn").addEventListener("click",()=>{window.open(`${M}/${e.toUpperCase()}`,"_blank")}),document.getElementById("open-pdbe-btn").addEventListener("click",()=>{window.open(`${S}/${e.toLowerCase()}`,"_blank")}),i.style.display="block",i.innerHTML='<p class="properties-loading">Loading 3D structure...</p>';const o=await y.getPdbFile(e);setTimeout(()=>{var r,a;try{const d=(a=(r=document.body)==null?void 0:r.classList)!=null&&a.contains("dark-mode")?"#e0e0e0":"white",l=$3Dmol.createViewer(i,{backgroundColor:d,width:"100%",height:"100%"});i.viewer=l,l.addModel(o,"pdb"),l.setStyle({},{cartoon:{color:"#b3b3b3",opacity:.7}}),l.setStyle({hetflag:!0},{stick:{radius:.5,colorscheme:"element"}}),l.setStyle({hetflag:!0,resn:["HOH","H2O","WAT"]},{}),l.zoomTo(),l.render()}catch(d){console.error("Error creating 3Dmol viewer:",d),i.innerHTML='<div class="no-pdb-entries">Could not render 3D structure.</div>'}},100)}catch(s){console.error("Error fetching PDB details:",s),n.innerHTML='<div class="no-pdb-entries">Could not load details for this PDB entry.</div>',i.style.display="none";const o=s.status&&s.url?`Failed to load PDB details (status ${s.status}) from ${s.url}`:"Failed to load PDB entry details.";typeof showNotification=="function"&&showNotification(o,"error")}}close(){this.modal&&(this.modal.style.display="none")}createPDBDetailsHTML(e){var d,l,c,u,p,g,f,m,b,w,E,I;const t=((d=e.struct)==null?void 0:d.title)||"Not available",n=((u=(c=(l=e.citation)==null?void 0:l[0])==null?void 0:c.rcsb_authors)==null?void 0:u.join(", "))||"Not available",i=(p=e.rcsb_accession_info)!=null&&p.initial_release_date?new Date(e.rcsb_accession_info.initial_release_date).toLocaleDateString():"Not available",s=(m=(f=(g=e.rcsb_entry_info)==null?void 0:g.resolution_combined)==null?void 0:f[0])!=null&&m.toFixed(2)?`${e.rcsb_entry_info.resolution_combined[0].toFixed(2)} Å`:"N/A",o=((w=(b=e.exptl)==null?void 0:b[0])==null?void 0:w.method)||"N/A",r=((I=(E=e.entity_src_gen)==null?void 0:E[0])==null?void 0:I.pdbx_host_org_scientific_name)||"Not available";return`
            <div class="details-section" style="padding-bottom: 0;">
                <div class="pdb-details-grid" style="grid-template-columns: repeat(5, 1fr);">
                    <div class="pdb-info-item">
                        <div class="pdb-info-label">PDB ID</div>
                        <div class="pdb-info-value">${e.rcsb_id.toUpperCase()}</div>
                    </div>
                    <div class="pdb-info-item">
                        <div class="pdb-info-label">Organism</div>
                        <div class="pdb-info-value">${r}</div>
                    </div>
                    <div class="pdb-info-item">
                        <div class="pdb-info-label">Method</div>
                        <div class="pdb-info-value">${o}</div>
                    </div>
                    <div class="pdb-info-item">
                        <div class="pdb-info-label">Resolution</div>
                        <div class="pdb-info-value">${s}</div>
                    </div>
                    <div class="pdb-info-item">
                        <div class="pdb-info-label">Release Date</div>
                        <div class="pdb-info-value">${i}</div>
                    </div>
                </div>
            </div>
            <div class="details-section" style="padding-top: 0;">
                 <div class="pdb-details-grid">
                    <div class="pdb-info-item" style="grid-column: 1 / -1;">
                        <div class="pdb-info-label">Title</div>
                        <div class="pdb-info-value" title="${t}">${t}</div>
                    </div>
                    <div class="pdb-info-item" style="grid-column: 1 / -1;">
                        <div class="pdb-info-label">Authors</div>
                        <div class="pdb-info-value">${n}</div>
                    </div>
                </div>
                <div class="pdb-external-links">
                    <button id="open-rcsb-btn" class="view-structure-btn rcsb-btn">RCSB PDB</button>
                    <button id="open-pdbe-btn" class="view-structure-btn pdbe-btn">PDBe</button>
                </div>
            </div>
            <div class="details-section">
                <h4>Interactive Molecular Structure</h4>
            </div>
        `}}const Be=["ATP","NAG","FAD","HEM","NAD","ADP","SAM","FMN","GDP","GTP"];class Me{constructor(e){this.moleculeManager=e,this.modal=document.getElementById("add-molecule-modal"),this.codeInput=document.getElementById("molecule-code"),this.errorText=document.getElementById("ccd-error"),this.confirmBtn=document.getElementById("confirm-add-btn"),this.cancelBtn=document.getElementById("cancel-btn"),this.closeBtn=document.getElementById("close-modal"),this.luckyBtn=document.getElementById("feeling-lucky-btn"),this.pdbIdInput=document.getElementById("pdb-id"),this.authorResidueNumberInput=document.getElementById("author-residue-number"),this.chainIdInput=document.getElementById("chain-id"),this.instanceError=document.getElementById("instance-error"),this.cancelBtn&&this.cancelBtn.addEventListener("click",()=>this.close()),this.closeBtn&&this.closeBtn.addEventListener("click",()=>this.close()),window.addEventListener("click",t=>{t.target===this.modal&&this.close()}),this.codeInput&&this.codeInput.addEventListener("input",()=>this.handleInput()),this.pdbIdInput&&this.pdbIdInput.addEventListener("input",()=>this.handleInstanceInput()),this.authorResidueNumberInput&&this.authorResidueNumberInput.addEventListener("input",()=>this.handleInstanceInput()),this.chainIdInput&&this.chainIdInput.addEventListener("input",()=>this.handleInstanceInput()),this.confirmBtn&&this.confirmBtn.addEventListener("click",()=>this.handleSubmit()),this.luckyBtn&&(this.luckyCodes=Be,this.luckyCodes.length>0&&this.luckyBtn.addEventListener("click",()=>this.handleLucky()))}open(){this.modal&&(this.reset(),this.modal.style.display="block",this.codeInput.focus())}close(){this.modal&&(this.modal.style.display="none")}reset(){this.codeInput&&(this.codeInput.value=""),this.errorText&&(this.errorText.textContent=""),this.instanceError&&(this.instanceError.textContent=""),this.pdbIdInput&&(this.pdbIdInput.value=""),this.authorResidueNumberInput&&(this.authorResidueNumberInput.value=""),this.chainIdInput&&(this.chainIdInput.value=""),this.confirmBtn&&(this.confirmBtn.disabled=!0)}handleInput(){let e=this.codeInput.value.toUpperCase();this.codeInput.value=e;const t=/^[A-Z0-9]{3}$/.test(e);this.errorText&&(this.errorText.textContent=t?"":"Code must be 3 alphanumeric characters."),this.confirmBtn&&(this.confirmBtn.disabled=!t)}handleInstanceInput(){this.instanceError&&(this.instanceError.textContent="")}handleLucky(){if(!this.luckyCodes||this.luckyCodes.length===0)return;let e,t=0;do e=this.luckyCodes[Math.floor(Math.random()*this.luckyCodes.length)],t++;while(this.moleculeManager.getMolecule(e)&&t<10);this.moleculeManager.addMolecule(e)?window.showNotification(`Adding molecule ${e}...`,"success"):window.showNotification(`Molecule ${e} already exists`,"info"),this.close()}handleSubmit(){const e=this.codeInput.value.toUpperCase(),t=this.pdbIdInput.value.trim().toUpperCase(),n=this.authorResidueNumberInput.value.trim(),i=this.chainIdInput.value.trim().toUpperCase();if(t||n||i){if(!(t&&n&&i)){this.instanceError&&(this.instanceError.textContent="PDB ID, residue number and chain are required.");return}this.moleculeManager.addPdbInstance({code:e,pdbId:t,chainId:i,authorResidueNumber:n})?window.showNotification(`Adding ligand ${e} from ${t}...`,"success"):window.showNotification(`Ligand ${e} instance already exists`,"info")}else this.moleculeManager.addMolecule(e)?window.showNotification(`Adding molecule ${e}...`,"success"):window.showNotification(`Molecule ${e} already exists`,"info");this.close()}}class Se{constructor(e){this.moleculeManager=e,this.searchBtn=null,this.searchInput=null,this.suggestedDropdown=null,this.resultsContainer=null,this.resultsBody=null,this.loadingIndicator=null,this.noResultsMessage=null,this.hideAidsToggle=null,this.hideIonsToggle=null,this.currentProteinDetails=[],this.resultsCountMessage=null,this.loadMoreBtn=null,this.allPdbIds=[],this.totalResults=0,this.currentOffset=0,this.limit=20}init(){return this.searchBtn=document.getElementById("protein-group-search-btn"),this.searchInput=document.getElementById("protein-group-search"),this.suggestedDropdown=document.getElementById("suggested-groups-dropdown"),this.resultsContainer=document.getElementById("protein-results-table-container"),this.resultsBody=document.getElementById("protein-results-tbody"),this.loadingIndicator=document.getElementById("protein-loading-indicator"),this.noResultsMessage=document.getElementById("no-protein-results-message"),this.hideAidsToggle=document.getElementById("hide-aids-toggle"),this.hideIonsToggle=document.getElementById("hide-ions-toggle"),this.resultsCountMessage=document.getElementById("protein-results-count"),this.loadMoreBtn=document.getElementById("protein-load-more"),this.searchBtn&&this.searchBtn.addEventListener("click",()=>{const e=this.searchInput.value.trim();e?this.fetchProteinEntries(e):showNotification("Please enter a Group ID or UniProt ID.","info")}),this.searchInput&&this.searchInput.addEventListener("keydown",e=>{if(e.key==="Enter"){e.preventDefault();const t=this.searchInput.value.trim();t?this.fetchProteinEntries(t):showNotification("Please enter a Group ID or UniProt ID.","info"),this.searchInput.blur()}}),this.hideAidsToggle&&this.hideAidsToggle.addEventListener("change",()=>{this.currentProteinDetails.length>0&&this.displayResults(this.currentProteinDetails)}),this.hideIonsToggle&&this.hideIonsToggle.addEventListener("change",()=>{this.currentProteinDetails.length>0&&this.displayResults(this.currentProteinDetails)}),this.suggestedDropdown&&this.suggestedDropdown.addEventListener("change",()=>{const e=this.suggestedDropdown.value;e&&(this.searchInput&&(this.searchInput.value=e),this.fetchProteinEntries(e))}),this.loadMoreBtn&&this.loadMoreBtn.addEventListener("click",()=>{this.loadMoreResults()}),this}async fetchProteinEntries(e){this.loadingIndicator.style.display="block",this.resultsContainer.style.display="none",this.noResultsMessage.style.display="none",this.resultsCountMessage&&(this.resultsCountMessage.style.display="none"),this.loadMoreBtn&&(this.loadMoreBtn.style.display="none");try{let t=[];e.toUpperCase().startsWith("G_")?t=(await y.getProteinGroup(e)).rcsb_group_container_identifiers.group_member_ids:t=await y.getPdbEntriesForUniprot(e),this.allPdbIds=t,this.totalResults=t.length,this.currentOffset=0,this.currentProteinDetails=[];const n=await this.fetchMemberDetails(this.allPdbIds,this.limit,this.currentOffset);this.currentOffset+=n.length,this.currentProteinDetails=n,await this.displayResults(this.currentProteinDetails),this.updateResultsInfo()}catch(t){console.error("Error fetching protein entries:",t),this.noResultsMessage.textContent="Could not fetch data for the given identifier.",this.noResultsMessage.style.display="block";const n=t.status&&t.url?`Failed to fetch protein data (status ${t.status}) from ${t.url}`:"Failed to fetch protein data.";typeof showNotification=="function"&&showNotification(n,"error")}finally{this.loadingIndicator.style.display="none"}}async fetchMemberDetails(e,t=20,n=0){const s=e.slice(n,n+t).map(async o=>{try{return await y.getRcsbEntry(o)}catch{return{rcsb_id:o,error:"Failed to fetch details"}}});return Promise.all(s)}async loadMoreResults(){if(!(this.currentOffset>=this.totalResults)){this.loadingIndicator.style.display="block";try{const e=await this.fetchMemberDetails(this.allPdbIds,this.limit,this.currentOffset);this.currentOffset+=e.length,this.currentProteinDetails=this.currentProteinDetails.concat(e),await this.displayResults(e,!0),this.updateResultsInfo()}catch(e){console.error("Error loading more results:",e),typeof showNotification=="function"&&showNotification("Failed to load more protein entries.","error")}finally{this.loadingIndicator.style.display="none"}}}updateResultsInfo(){if(!(!this.resultsCountMessage||!this.loadMoreBtn)){if(this.totalResults>0){const e=Math.min(this.currentOffset,this.totalResults);this.resultsCountMessage.textContent=`Showing ${e} of ${this.totalResults} results.`,this.resultsCountMessage.style.display="block"}else this.resultsCountMessage.style.display="none";this.currentOffset<this.totalResults?this.loadMoreBtn.style.display="block":this.loadMoreBtn.style.display="none"}}async fetchBoundLigands(e){try{return(await y.getLigandMonomers(e))[e.toLowerCase()]||[]}catch(t){return console.error(`Error fetching bound ligands for ${e}:`,t),[]}}renderBoundLigands(e,t){if(!e||e.length===0)return'<div class="bound-ligands-container"></div>';const n=e.slice(0,5).map(s=>`
            <div class="ligand-img-container">
                  <img src="${N}/${s.chem_comp_id}_200.svg" alt="${s.chem_comp_id}" title="${s.chem_comp_id}: ${s.chem_comp_name}" class="bound-ligand-img">
                  <div class="ligand-img-overlay">
                      <button class="ligand-action-btn add-ligand" data-ccd-code="${s.chem_comp_id}" data-pdb-id="${t}" data-chain-id="${s.chain_id}" data-author-residue-number="${s.author_residue_number}">+</button>
                  </div>
              </div>
          `).join(""),i=e.length>5?`<span class="more-ligands-indicator" title="${e.length-5} more ligands">+${e.length-5}</span>`:"";return`<div class="bound-ligands-container">${n}${i}</div>`}async displayResults(e,t=!1){var n,i,s,o,r;if(t||(this.resultsBody.innerHTML=""),e&&e.length>0){const a=this.hideAidsToggle&&this.hideAidsToggle.checked,d=this.hideIonsToggle&&this.hideIonsToggle.checked;for(const l of e){const c=this.resultsBody.insertRow(),u=l.rcsb_id,p=((n=l.struct)==null?void 0:n.title)||"N/A",g=((o=(s=(i=l.rcsb_entry_info)==null?void 0:i.resolution_combined)==null?void 0:s[0])==null?void 0:o.toFixed(2))||"N/A",f=(r=l.rcsb_accession_info)!=null&&r.initial_release_date?new Date(l.rcsb_accession_info.initial_release_date).toLocaleDateString():"N/A",m=l.rcsb_primary_citation,b=(m==null?void 0:m.title)||"N/A",w=m!=null&&m.pdbx_database_id_doi?`https://doi.org/${m.pdbx_database_id_doi}`:m!=null&&m.pdbx_database_id_PubMed?`https://pubmed.ncbi.nlm.nih.gov/${m.pdbx_database_id_PubMed}/`:null,E=w?`<a href="${w}" target="_blank">${b}</a>`:b,I=`${le}/${u.toLowerCase()}_assembly-1.jpeg`;let L=await this.fetchBoundLigands(u);a&&(L=L.filter(v=>!he.includes(v.chem_comp_id))),d&&(L=L.filter(v=>!me.includes(v.chem_comp_id))),c.innerHTML=`
                    <td data-label="Image"><img src="${I}" alt="${u} thumbnail" class="protein-thumbnail"></td>
                    <td data-label="PDB ID"><a href="#" class="pdb-id-link" data-pdb-id="${u}">${u}</a></td>
                    <td data-label="Title">${p}</td>
                    <td data-label="Resolution">${g}</td>
                    <td data-label="Release Date">${f}</td>
                    <td data-label="Publication">${E}</td>
                    <td data-label="Bound Ligands" class="bound-ligands-cell">${this.renderBoundLigands(L,u)}</td>
                    <td data-label="View Structure" class="view-buttons-cell">
                        <button class="view-structure-btn rcsb-btn" data-pdb-id="${u}">RCSB PDB</button>
                        <button class="view-structure-btn pdbe-btn" data-pdb-id="${u}">PDBe</button>
                    </td>
                `,c.querySelector(".pdb-id-link").addEventListener("click",v=>{v.preventDefault(),this.moleculeManager.showPDBDetailsModal(v.target.dataset.pdbId)}),c.querySelector(".view-structure-btn.rcsb-btn").addEventListener("click",v=>{window.open(`${M}/${v.target.dataset.pdbId}`,"_blank")}),c.querySelector(".view-structure-btn.pdbe-btn").addEventListener("click",v=>{window.open(`${S}/${v.target.dataset.pdbId.toLowerCase()}`,"_blank")}),c.querySelectorAll(".add-ligand").forEach(v=>{v.addEventListener("click",q=>{const{ccdCode:T,pdbId:G,chainId:Y,authorResidueNumber:W}=q.currentTarget.dataset;this.moleculeManager.addPdbInstance({code:T,pdbId:G,chainId:Y,authorResidueNumber:W})?showNotification(`Adding molecule ${T}...`,"success"):showNotification(`Molecule ${T} already exists`,"info")})})}this.resultsContainer.style.display="block",this.noResultsMessage.style.display="none"}else t||(this.noResultsMessage.textContent="No PDB entries found in this group.",this.noResultsMessage.style.display="block",this.resultsContainer.style.display="none")}}class De{constructor(){this.viewerContainer=null,this.viewer=null,this.currentPdbId=null,this.pdbInput=null,this.loadBtn=null,this.showCartoon=null,this.showSticks=null,this.showSurface=null,this.surfaceOpacity=null,this.colorScheme=null,this.hideSolvent=null,this.hideIons=null,this.zoomLigandsBtn=null,this.resetViewBtn=null,this.spinToggle=null,this._resizeHandler=null}init(){this.viewerContainer=document.getElementById("pymol-viewer"),this.pdbInput=document.getElementById("pymol-pdb-id"),this.loadBtn=document.getElementById("pymol-load-btn"),this.showCartoon=document.getElementById("pymol-cartoon"),this.showSticks=document.getElementById("pymol-sticks"),this.showSurface=document.getElementById("pymol-surface"),this.surfaceOpacity=document.getElementById("pymol-surface-opacity"),this.colorScheme=document.getElementById("pymol-color-scheme"),this.hideSolvent=document.getElementById("pymol-hide-solvent"),this.hideIons=document.getElementById("pymol-hide-ions"),this.zoomLigandsBtn=document.getElementById("pymol-zoom-ligands"),this.resetViewBtn=document.getElementById("pymol-reset-view"),this.spinToggle=document.getElementById("pymol-spin"),this.loadBtn&&this.loadBtn.addEventListener("click",()=>this.handleLoad()),this.pdbInput&&this.pdbInput.addEventListener("keydown",n=>{n.key==="Enter"&&(n.preventDefault(),this.handleLoad(),this.pdbInput.blur())}),[this.showCartoon,this.showSticks,this.showSurface,this.surfaceOpacity,this.colorScheme,this.hideSolvent,this.hideIons].forEach(n=>n&&n.addEventListener("change",()=>this.applyStyles())),this.zoomLigandsBtn&&this.zoomLigandsBtn.addEventListener("click",()=>this.zoomLigands()),this.resetViewBtn&&this.resetViewBtn.addEventListener("click",()=>this.resetView()),this.spinToggle&&this.spinToggle.addEventListener("change",()=>this.updateSpin()),this._resizeHandler=()=>this.resizeToWindow(),window.addEventListener("resize",this._resizeHandler);const t=document.getElementById("pymol-interface-content");if(t&&typeof ResizeObserver<"u"){const n=new ResizeObserver(()=>this.resizeToWindow());n.observe(t),this._panelObserver=n}return setTimeout(()=>this.resizeToWindow(),0),this}ensureViewer(){var e,t;if(!this.viewer&&this.viewerContainer){const n=(t=(e=document.body)==null?void 0:e.classList)!=null&&t.contains("dark-mode")?"#e0e0e0":"white";this.viewer=$3Dmol.createViewer(this.viewerContainer,{backgroundColor:n,width:"100%",height:"100%"}),this.viewerContainer.viewer=this.viewer}}async handleLoad(){var t;const e=(((t=this.pdbInput)==null?void 0:t.value)||"").trim();if(!e){typeof showNotification=="function"&&showNotification("Enter a PDB ID to load","info");return}await this.loadPdb(e)}async loadPdb(e){try{if(this.ensureViewer(),!this.viewer)return;this.resizeToWindow();const t=await y.getPdbFile(e.toUpperCase());this.viewer.clear(),this.viewer.addModel(t,"pdb"),this.currentPdbId=e.toUpperCase(),this.applyStyles(),this.viewer.zoomTo(),this.viewer.render(),typeof showNotification=="function"&&showNotification(`Loaded ${this.currentPdbId}`,"success")}catch(t){console.error("Failed to load PDB:",t),typeof showNotification=="function"&&showNotification("Failed to load PDB","error")}}getIonResidues(){return["NA","CL","MG","K","CA","ZN","MN","FE","CU","NI","CO","CD","SR","CS"]}getSolventResidues(){return["HOH","WAT","DOD"]}applyStyles(){var u,p,g,f,m,b,w;if(!this.viewer)return;this.resizeToWindow();const e=!!((u=this.showCartoon)!=null&&u.checked),t=!!((p=this.showSticks)!=null&&p.checked),n=!!((g=this.showSurface)!=null&&g.checked),i=!!((f=this.hideSolvent)!=null&&f.checked),s=!!((m=this.hideIons)!=null&&m.checked),o=((b=this.colorScheme)==null?void 0:b.value)||"chain",r=Number(((w=this.surfaceOpacity)==null?void 0:w.value)||.5);this.viewer.setStyle({},{}),this.viewer.removeAllSurfaces();const a={hetflag:!1},d={hetflag:!0},l=[];i&&l.push(...this.getSolventResidues()),s&&l.push(...this.getIonResidues());const c=l.length?{...d,not:{resn:l}}:d;if(e){const E=o==="spectrum"?"spectrum":"chain";this.viewer.setStyle(a,{cartoon:{colorscheme:E}})}t&&this.viewer.setStyle(c,{stick:{radius:.25,colorscheme:"element"}}),n&&this.viewer.addSurface($3Dmol.SurfaceType.MS,{opacity:r,color:"white"},a),this.viewer.render()}zoomLigands(){this.viewer&&(this.viewer.zoomTo({hetflag:!0}),this.viewer.render())}resetView(){this.viewer&&(this.viewer.zoomTo(),this.viewer.render())}updateSpin(){var e;this.viewer&&((e=this.spinToggle)!=null&&e.checked?this.viewer.spin("y"):this.viewer.spin(!1))}resizeToWindow(){if(this.viewerContainer)try{const e=this.viewerContainer.getBoundingClientRect();let n=window.innerHeight-e.top-20;n<200&&(n=200),this.viewerContainer.style.height=`${Math.floor(n)}px`,this.viewer&&typeof this.viewer.resize=="function"&&(this.viewer.resize(),this.viewer.render())}catch{}}}class $e{constructor(){this.modal=document.getElementById("comparison-modal"),this.viewerContainer=document.getElementById("comparison-viewer"),this.title=document.getElementById("comparison-title");const e=document.getElementById("close-comparison-modal");e&&e.addEventListener("click",()=>this.close()),window.addEventListener("click",t=>{t.target===this.modal&&this.close()})}show(e,t){!e||!t||(this.title&&(this.title.textContent=`${e.code} vs ${t.code}`),this.viewerContainer&&(this.viewerContainer.innerHTML=""),this.modal&&(this.modal.style.display="block"),setTimeout(()=>{var n,i;try{const s=(i=(n=document.body)==null?void 0:n.classList)!=null&&i.contains("dark-mode")?"#e0e0e0":"white",o=$3Dmol.createViewer(this.viewerContainer,{backgroundColor:s});this.viewerContainer.viewer=o;const r=o.addModel(e.sdf,"sdf"),a=o.addModel(t.sdf,"sdf");r.setStyle({},{stick:{colorscheme:"cyanCarbon"}}),a.setStyle({},{stick:{colorscheme:"magentaCarbon"}}),this._alignModels(r,a),o.zoomTo(),o.render()}catch(s){console.error("Error rendering comparison viewer:",s),this.viewerContainer&&(this.viewerContainer.innerHTML='<p style="text-align:center;padding:20px;">Render Error</p>')}},100))}_alignModels(e,t){if(!e||!t||!e.selectedAtoms||!t.selectedAtoms)return;const n=e.selectedAtoms({}),i=t.selectedAtoms({});if(!n.length||!i.length)return;const s=c=>{let u=0,p=0,g=0;for(const f of c)u+=f.x,p+=f.y,g+=f.z;return{x:u/c.length,y:p/c.length,z:g/c.length}},o=s(n),r=s(i),a=o.x-r.x,d=o.y-r.y,l=o.z-r.z;for(const c of i)c.x+=a,c.y+=d,c.z+=l}close(){this.modal&&(this.modal.style.display="none")}}class Te{constructor(){this.repository=new ge([...ce.map(e=>({code:e,status:"pending"})),...ue.map(e=>({...e,status:"pending"}))]),this.grid=null,this.loadingIndicator=null,this.cardUI=null,this.loader=null,this.ligandModal=null,this.boundLigandTable=null,this.pdbDetailsModal=null,this.addModal=null,this.comparisonModal=null,this.compareQueue=[]}init(){this.grid=document.getElementById("molecule-grid"),this.loadingIndicator=document.querySelector(".loading-indicator"),this.cardUI=new Le(this.grid,this.repository,{onDelete:r=>this.confirmDelete(r),onShowDetails:(r,a,d)=>this.showMoleculeDetails(r,a,d),onCompare:r=>this.queueComparison(r)}),this.loader=new pe(this.repository,this.cardUI),this.ligandModal=new Ie(this),this.boundLigandTable=new fe(r=>this.addMolecule(r),r=>this.showMoleculeDetails(r),this.ligandModal),this.pdbDetailsModal=new _e(this.boundLigandTable),this.addModal=new Me(this),this.comparisonModal=new $e,document.getElementById("add-molecule-btn").addEventListener("click",()=>{this.addModal&&this.addModal.open()}),document.getElementById("delete-all-btn").addEventListener("click",()=>{confirm("Delete all molecules?")&&this.deleteAllMolecules()});const e=document.getElementById("export-modal"),t=document.getElementById("export-filename"),n=document.getElementById("export-remove-h-toggle"),i=()=>e.style.display="none";document.getElementById("export-btn").addEventListener("click",()=>{e&&(t.value="molecules",n.checked=!1,e.style.display="block")}),document.getElementById("cancel-export-btn").addEventListener("click",i),document.getElementById("close-export-modal").addEventListener("click",i),document.getElementById("confirm-export-btn").addEventListener("click",()=>{const r=this.repository.exportToSdf({removeHydrogens:n.checked});if(!r){C("No SDF data to export","info");return}let a=t.value.trim()||"molecules";a.toLowerCase().endsWith(".sdf")||(a+=".sdf");const d=new Blob([r],{type:"chemical/x-mdl-sdfile"}),l=URL.createObjectURL(d),c=document.createElement("a");c.href=l,c.download=a,document.body.appendChild(c),c.click(),document.body.removeChild(c),URL.revokeObjectURL(l),i()});const s=document.querySelectorAll(".tab-button"),o=[document.getElementById("molecule-library-content"),document.getElementById("fragment-library-content"),document.getElementById("protein-browser-content"),document.getElementById("pymol-interface-content")];return s.forEach((r,a)=>{r.addEventListener("click",()=>{s.forEach((d,l)=>d.classList.toggle("active",l===a)),o.forEach((d,l)=>{d.style.display=l===a?"block":"none",l===a&&d.id==="pymol-interface-content"&&window.pyMolInterface&&setTimeout(()=>window.pyMolInterface.resizeToWindow(),0)})})}),this}addMolecule(e){const t=this.repository.addMolecule(e);return t&&this.loader.loadMolecule(e),t}addPdbInstance({code:e,pdbId:t,chainId:n,authorResidueNumber:i}){return this.addMolecule({code:e,pdbId:t,chainId:n,authorResidueNumber:i})}deleteMolecule(e){if(this.repository.removeMolecule(e)){const t=this.grid.querySelector(`[data-molecule-code="${e}"]`);return t&&t.remove(),!0}return!1}deleteAllMolecules(){this.repository.deleteAllMolecules(),this.cardUI&&this.cardUI.clearAll(),C("All molecules deleted successfully!","info")}getMolecule(e){return this.repository.getMolecule(e)}getAllMolecules(){return this.repository.getAllMolecules()}updateMoleculeStatus(e,t){this.repository.updateMoleculeStatus(e,t)}queueComparison(e){if(!this.compareQueue.includes(e))if(this.compareQueue.push(e),this.compareQueue.length===2){const[t,n]=this.compareQueue,i=this.getMolecule(t),s=this.getMolecule(n);i&&s&&this.comparisonModal&&(i.sdf&&s.sdf?this.comparisonModal.show(i,s):typeof C=="function"&&C("Both molecules must be loaded before comparison","error")),this.compareQueue=[]}else typeof C=="function"&&C("Select another molecule to compare","info")}loadAllMolecules(){this.loadingIndicator&&(this.loadingIndicator.style.display="block"),this.loader.loadAllMolecules().finally(()=>{this.loadingIndicator&&(this.loadingIndicator.style.display="none")})}showMoleculeDetails(e,t,n){this.ligandModal&&this.ligandModal.show(e,t,n)}fetchRCSBDetails(e){return this.pdbDetailsModal?this.pdbDetailsModal.fetchRCSBDetails(e):Promise.resolve(null)}showPDBDetailsModal(e){this.pdbDetailsModal&&this.pdbDetailsModal.showPDBDetailsModal(e)}confirmDelete(e){confirm(`Delete ${e}?`)&&this.deleteMolecule(e)}}const $=new Te().init();$.loadAllMolecules();const Ae=typeof initRDKitModule=="function"?initRDKitModule():Promise.resolve(null),x=new ye($,{notify:C,rdkit:Ae}).init();x.loadFragments();const D=document.getElementById("add-fragment-modal"),U=document.getElementById("add-fragment-btn"),O=document.getElementById("cancel-add-fragment-btn"),z=document.getElementById("close-fragment-modal"),V=document.getElementById("confirm-add-fragment-btn"),Ne=()=>{D&&(D.style.display="block")},P=()=>{D&&(D.style.display="none")};U&&U.addEventListener("click",Ne);O&&O.addEventListener("click",P);z&&z.addEventListener("click",P);V&&V.addEventListener("click",()=>{const h=document.getElementById("fragment-name"),e=document.getElementById("fragment-query"),t=document.getElementById("fragment-source"),n=document.getElementById("fragment-description"),i={name:h?h.value.trim():"",query:e?e.value.trim():"",source:t?t.value.trim():"",description:n?n.value.trim():""};x.addFragment(i)&&(h&&(h.value=""),e&&(e.value=""),t&&(t.value="custom"),n&&(n.value=""),P())});const ke=new Se($).init(),xe=new De().init();function C(h,e="info"){const t=document.createElement("div");t.className=`notification ${e}`,t.textContent=h,Object.assign(t.style,{position:"fixed",top:"20px",right:"20px",padding:"12px 20px",borderRadius:"6px",color:"white",fontWeight:"500",zIndex:"1001",opacity:"0",transform:"translateY(-20px)",transition:"all 0.3s ease"}),e==="success"?t.style.background="#4CAF50":e==="error"?t.style.background="#f44336":t.style.background="#6e45e2",document.body.appendChild(t),setTimeout(()=>{t.style.opacity="1",t.style.transform="translateY(0)"},10),setTimeout(()=>{t.style.opacity="0",t.style.transform="translateY(-20px)",setTimeout(()=>{t.parentNode&&t.parentNode.removeChild(t)},300)},3e3)}window.moleculeManager=$;window.fragmentLibrary=x;window.proteinBrowser=ke;window.pyMolInterface=xe;window.showNotification=C;function Pe(){document.body.classList.toggle("dark-mode");const h=document.body.classList.contains("dark-mode"),e=h?"#e0e0e0":"white";document.querySelectorAll(".viewer-container, .molecule-viewer, .details-viewer").forEach(n=>{n.viewer&&typeof n.viewer.setBackgroundColor=="function"?(n.viewer.setBackgroundColor(e),n.viewer.render()):n.style.background=e});const t=document.getElementById("theme-toggle-icon");t&&(t.textContent=h?"light_mode":"dark_mode")}function Re(){const h=document.getElementById("theme-toggle");h&&h.addEventListener("click",Pe)}Re();
